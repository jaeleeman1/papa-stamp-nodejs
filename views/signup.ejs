<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <!-- Meta, title, CSS, favicons, etc. -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Gentelella Alela! | </title>

  <!-- Bootstrap -->
  <link href="/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <!-- NProgress -->
  <link href="/vendors/nprogress/nprogress.css" rel="stylesheet">
  <!-- Animate.css -->
  <link href="/vendors/animate.css/animate.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/jquery.toast.min.css" type="text/css"/>

  <!-- Custom Theme Style -->
  <link href="/css/custom.css" rel="stylesheet">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css">
  <style>
    .ui-dialog .ui-dialog-buttonpane button {
      font-size:1em;
    }
  </style>
  <script type ="text/javascript" src="/js/jquery-2.2.3.min.js"></script>
  <script src='/js/jquery.toast.min.js' type='text/javascript'></script>
  <script src="https://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
</head>

<form action="/" method="get" style="display:none" name="list_setting" id="list_setting">
    <input type="hidden" name="url" id="url" value="<%= url %>"/>
    <input type="hidden" name="current_lat" id="current_lat" value=""/>
    <input type="hidden" name="current_lng" id="current_lng" value=""/>
    <input type="hidden" name="authCheck" id="authCheck" value="false"/>
    <input type="hidden" name="authNum" id="authNum" value=""/>
</form>

<body class="login">
<div>
  <a class="hiddenanchor" id="signup"></a>
  <a class="hiddenanchor" id="signin"></a>

  <div class="login_wrapper">
    <div class="animate form login_form">
      <section class="login_content">
        <form>
          <h1>파파스탬프 회원가입</h1>
          <div>
            <input type="text" class="form-control" placeholder="E-Mail" required="" id="loginEmail"/>
          </div>
          <div>
            <input type="password" class="form-control" placeholder="Password" required="" id="loginPassword"/>
          </div>
          <div>
            <input type="password" class="form-control" placeholder="Password-Cofirm" required="" id="loginPasswordConfirm"/>
          </div>
          <div>
            <input type="text" class="form-control" placeholder="Phone-Number" required="" id="phoneNumber"/>
          </div>
          <div class="input-group">
            <input id="authCode" type="text" class="form-control" placeholder="인증번호를 입력하세요!" pattern="^(?:\(\d{3}\)|\d{3})[- ]?\d{3}[- ]?\d{4}$">
            <span class="input-group-btn">
              <button id="authButton" style="margin-bottom:20px;" class="btn btn-default" type="button" onclick="authNumber();">인증번호 요청</button>
            </span>
          </div>
          <div>
            <a class="btn btn-default submit" id="btn_send" style="font-size: 20px;margin-bottom: 50px;">회원가입</a>
            <a id="kakao-login-btn"></a>
          </div>

          <div class="clearfix"></div>

          <div class="separator">
            <p class="change_link">
              <a href="#findIdPw" class="to_register" id="signup">ID / Password 찾기</a>
            </p>

            <div class="clearfix"></div>
            <br />

            <div>
              <h1><img style="width:80px;margin-right:20px;" src="/images/papastamp_icon.png"/> 파파 스탬프 !!! </h1>
            </div>
          </div>
        </form>
      </section>
    </div>
  </div>
</div>

<div id="signup-confirm" class="dialog-confirm">
  <figure>
    <h5 class="confirm-user-number" id="confirm-user-number"></h5>
    <div style="margin: 30px;"> 입력하신 사항으로 가입하시겠습니까?</div>
  </figure>
</div>

<script type ="text/javascript">
    $(function() {
        if (navigator.geolocation) {
            // HTML5의 geolocation으로 사용할 수 있는지 확인합니다
            if (navigator.geolocation) {
                // GeoLocation을 이용해서 접속 위치를 얻어옵니다
                navigator.geolocation.getCurrentPosition(function (position) {
                    currentLat = position.coords.latitude; // 위도
                    currentLng = position.coords.longitude; // 경도

                    $("#current_lat").val(currentLat);
                    $("#current_lng").val(currentLng);
                });
            } else { // HTML5의 GeoLocation을 사용할 수 없을때 마커 표시 위치와 인포윈도우 내용을 설정합니다
                console.error("geolocation error : code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        }

        if($("#current_lat").val().length == 0 && $("#current_lng").val().length == 0) {
            $('#current_lat').val('37.4979887529');
            $('#current_lng').val('127.0296421998');
        }

        var keyNumber = '';
        $("#phoneNumber").on("input propertychange",function() {
            var val = this.value.replace(/\D/g, '');
            var newVal = '';
            keyNumber = $(this).val();

            if (val.length > 3 && val.length < 8) {
                newVal += val.substr(0, 3) + '-';
                val = val.substr(3);
            }else if (val.length > 7) {
                newVal += val.substr(0, 3) + '-' + val.substr(3, 4) + '-';
                val = val.substr(7);
            }
            newVal += val;
            this.value = newVal;

            if($(this).val().length > 13) {
                $(this).val(keyNumber.substr(0, keyNumber.length - 1));
            }
        });

        $('#btn_send').on('click',
            function() {
                $.toast.config.align = 'center';
                $.toast.config.width = 210;

                var loginEmail = $('#loginEmail').val();
                var loginPassword = $('#loginPassword').val();
                var loginPasswordConfirm = $('#loginPasswordConfirm').val();

                if (loginEmail == "") {
                    $.toast('<h4>E-Mail</h4>을 입력하세요!!.', { type: 'info', duration: 3000 });
                    $('#loginEmail').focus();
                    return;
                }

                if (loginPassword == "") {
                    $.toast('<h4>Password</h4>를 입력하세요!!.', { type: 'info', duration: 3000 });
                    $('#loginPassword').focus();
                    return;
                }

                if (loginPasswordConfirm == "") {
                    $.toast.config.width = 270;
                    $.toast('<h4>Password Confirm</h4>를 입력하세요!!.', { type: 'info', duration: 3000 });
                    $('#loginPassword').focus();
                    return;
                }

                var loginInfo = '{"login_email":"' + loginEmail + '"}';
                $.ajax({
                    url: $("#url").val()+'/user/v1/userCheck',
                    type: 'GET',
                    traditional:true,
                    data: JSON.parse(loginInfo),
                    success: function(data) {
                        if(data.loginEmailCheck == '1'){
                            $.toast('<h4>존재하는 E-Mail</h4>입니다!.', { type: 'danger', duration: 3000 });
                        }else {
                            if(loginPassword != loginPasswordConfirm) {
                                $.toast('<h4>비밀 번호</h4>를 확인하세요!!.', { type: 'danger', duration: 3000 });
                            }else {
                                if($("#authCheck").val() == "true") {
                                    $("#signup-confirm").dialog({
                                        resizable: false,
                                        modal: true,
                                        title: "파파 스탬프 회원 가입",
                                        height: 210,
                                        width: 500,
                                        resizable:false,
                                        buttons: {
                                            "예": function () {
                                                signupcallback();
                                                $(this).dialog('close');
                                            },
                                            "아니오": function () {
                                                $(this).dialog('close');
                                            }
                                        }
                                    });
                                }else {
                                    $.toast.config.width = 310;
                                    $.toast('<h4>전화 번호 인증</h4>을 진행하시기 바랍니다.!', { type: 'danger', duration: 3000 });
                                }
                            }
                        }
                    },
                    error: function(request, status, error) {
                        console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                        console.log('Error occured');
                    }
                });
            });

        $('#findIdPw').on('click',
            function() {
                alert('가입');
            });
    });

    function signupcallback() {
        var userNumber = $("#phoneNumber").val();
        var userEmail = $('#loginEmail').val();
        var userPassword = $('#loginPassword').val();
        var headers = {};
        headers["user_number"] = userNumber;
        var dataString = {'user_email': userEmail, 'user_password': userPassword, 'current_lat': $('#current_lat').val(), 'current_lng': $('#current_lng').val()};
        $.ajax({
            url: $("#url").val() + '/user/v1/userInfo',
            type: 'POST',
            headers : headers,
            dataType: 'json',
            data : dataString,
            success: function(data) {
                if(data.result = 'success') {
                    setTimeout(function() {
                        location.href = $("#url").val();
                    }, 2000);
                    $.toast('<h4>회원가입</h4>이 완료되었습니다.', {type: 'info', duration: 2000});
                }else {
                    console.error('error');
                }
            },
            error: function(request, status, error) {
                console.error("used delete card : code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        });
    }

    function authNumber() {
        $.toast.config.align = 'center';
        $.toast.config.width = 230;
        var userNumber = $("#phoneNumber").val();

        var authCheckText = $("#authButton").text();
        if(authCheckText == "인증번호 확인") {
            var authNum = $("#authNum").val();
            var authCode = $("#authCode").val();
            if(authCode == '') {
                $.toast('<h4>발송된 번호</h4>를 입력하세요!!.</span>', {type: 'danger', duration: 3000});
            } else {
                if(authNum == authCode) {
                    $("#authCheck").val("true");
                    $("#authButton").html("인증확인 완료");
                    $.toast('<h4>인증</h4>이 완료되었습니다.', {type: 'info', duration: 3000});
                }else {
                    $.toast.config.width = 300;
                    $.toast('<h4>올바른 인증 번호</h4>를 입력하세요!!.</span>', {type: 'danger', duration: 3000});
                }
            }
        }else {
            if (userNumber == '') {
                $.toast('<h4>핸드폰 번호</h4>를 입력하세요!!.', {type: 'danger', duration: 3000});
                $('#phoneNumber').focus();
                return;
            }

            if (userNumber.length < 13) {
                $.toast.config.width = 250;
                $.toast('<h4>올바른 번호</h4>를 입력하세요!!.</span>', {type: 'danger', duration: 3000});
            } else {
                var numberString = {'login_number': userNumber};
                $.ajax({
                    url: $("#url").val() + '/user/v1/numberCheck',
                    type: 'GET',
                    dataType: 'json',
                    data : numberString,
                    success: function (data) {
                        if(data.result == 'exist') {
                            $.toast.config.width = 250;
                            $.toast('이미 가입된 <h4>사용자 번호</h4> 입니다.', {type: 'info', duration: 3000});
                        }else {
                            var randNum = Math.floor(Math.random() * 1000000)+100000;
                            if(randNum>1000000){
                                randNum = randNum - 100000;
                            }
                            $("#authNum").val(randNum);
                            var dataString = {'user_number': userNumber, 'send_type': 'signup', 'auth_code': randNum};
                            $.ajax({
                                url: $("#url").val() + '/notification/v1/sendsms',
                                type: 'GET',
                                dataType: 'json',
                                data : dataString,
                                success: function (data) {
                                    if(data.result == 'success') {
                                        $("#authButton").html("인증번호 확인");
                                        $.toast('<h4>인증 번호</h4>가 발송되었습니다.', {type: 'info', duration: 3000});
                                    }
                                },
                                error: function(request, status, error) {
                                    $.toast('<h4>인증 번호</h4>발송이 실패하였습니다.', {type: 'danger', duration: 3000});
                                    console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                                    console.log('Error occured');
                                }
                            });
                        }

                    },
                    error: function(request, status, error) {
                        console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                        console.log('Error occured');
                    }
                });
            }
        }
    }
</script>

</body>
</html>